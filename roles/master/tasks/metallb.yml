---
- name: Create metallb namespace
  command: kubectl create namespace metallb-system
  ignore_errors: yes

- name: Create memberlist secret
  shell: |
    kubectl create secret generic -n metallb-system memberlist \
    --from-literal=secretkey="$(openssl rand -base64 128)"
  ignore_errors: yes

# Descargamos y modificamos el manifiesto de MetalLB
- name: Download MetalLB manifest
  get_url:
    url: https://raw.githubusercontent.com/metallb/metallb/v0.13.7/config/manifests/metallb-native.yaml
    dest: /tmp/metallb-native.yaml

- name: Remove webhook configurations
  shell: |
    sed -i '/ValidatingWebhookConfiguration/,$d' /tmp/metallb-native.yaml
  ignore_errors: yes

- name: Install MetalLB
  command: kubectl apply -f /tmp/metallb-native.yaml
  ignore_errors: yes

- name: Wait for MetalLB pods
  shell: |
    kubectl -n metallb-system wait --for=condition=ready pod --selector=app=metallb --timeout=180s
  register: wait_result
  until: wait_result.rc == 0
  retries: 30
  delay: 10
  ignore_errors: yes

- name: Configure MetalLB
  template:
    src: metallb-config.yaml.j2
    dest: /tmp/metallb-config.yaml
  
- name: Apply MetalLB configuration
  command: kubectl apply -f /tmp/metallb-config.yaml
  retries: 3
  delay: 10 